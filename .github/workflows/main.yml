name: Bot Doctor (å…¨é“¾è·¯ä½“æ£€ Pro)

on:
  schedule:
    - cron: '30 * * * *' # æ¯å°æ—¶çš„ç¬¬30åˆ†é’Ÿè¿è¡Œ
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

# ğŸ”‘ã€æ–°å¢ã€‘èµ‹äºˆè¯»å– Action å†å²è®°å½•çš„æƒé™ï¼Œå¦åˆ™æŸ¥ä¸åˆ°ä¸Šä¸€æ¬¡çš„çŠ¶æ€
permissions:
  actions: read
  contents: read

jobs:
  full_body_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ğŸ•µï¸â€â™‚ï¸ã€æ–°å¢æ­¥éª¤ã€‘æŸ¥è¯¢ä¸Šä¸€æ¬¡ä½“æ£€ç»“æœ
      # å¦‚æœä¸Šä¸€æ¬¡æ˜¯ failureï¼Œä¼šè¾“å‡º was_failure=true
      - name: Check Last Run Status
        id: last_run
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { owner, repo } = context.repo;
              // è·å–å½“å‰ Workflow çš„å†å²è¿è¡Œè®°å½•ï¼ˆåªå–æœ€è¿‘çš„å·²å®Œæˆè®°å½•ï¼‰
              const { data } = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: 'bot-doctor.yml', // âš ï¸ æ³¨æ„ï¼šæ–‡ä»¶åæœ€å¥½ä¿æŒä¸€è‡´ï¼Œæˆ–è€…ä¾é  filter
                status: 'completed',
                per_page: 1
              });
              
              if (data.workflow_runs.length > 0) {
                const lastRun = data.workflow_runs[0];
                console.log(`ä¸Šä¸€æ¬¡è¿è¡Œç»“æœ: ${lastRun.conclusion}`);
                if (lastRun.conclusion === 'failure') {
                  core.setOutput('was_failure', 'true');
                }
              }
            } catch (err) {
              console.log('æŸ¥è¯¢å†å²è®°å½•å¤±è´¥ï¼Œè·³è¿‡æ¢å¤æ£€æµ‹', err);
            }

      - name: Install Dependencies
        run: npm install axios xml2js

      # ğŸ› ï¸ ç”Ÿæˆä½“æ£€è„šæœ¬ (ä¿æŒä½ çš„åŸé€»è¾‘ä¸å˜)
      - name: Create Diagnosis Script
        run: |
          cat << 'EOF' > doctor.js
          const axios = require("axios");
          const xml2js = require("xml2js");
          const fs = require("fs");

          const API_URL = process.env.API_URL;
          const TIMEOUT = 30000; 

          // ğŸ”‘ ä½¿ç”¨ä½ çš„ç®¡ç†å‘˜ID
          const ADMIN_ID = "o4UNGw6r9OL9q_4jRAfed_jnvXh8";

          async function testFeature(featureName, command, expectedKeywords) {
            console.log(`\n----------------------------------------`);
            console.log(`ğŸ©º [æ£€æµ‹]: ${featureName}`);
            
            const payload = `
              <xml>
                <ToUserName><![CDATA[gh_monitor]]></ToUserName>
                <FromUserName><![CDATA[${ADMIN_ID}]]></FromUserName> 
                <CreateTime>${Math.floor(Date.now() / 1000)}</CreateTime>
                <MsgType><![CDATA[text]]></MsgType>
                <Content><![CDATA[${command}]]></Content>
              </xml>
            `;

            try {
              const res = await axios.post(API_URL, payload, {
                headers: { "Content-Type": "text/xml" },
                timeout: TIMEOUT
              });

              if (res.status !== 200) throw new Error(`HTTP ${res.status}`);

              const parser = new xml2js.Parser({ explicitArray: false });
              const result = await parser.parseStringPromise(res.data);
              const reply = (result && result.xml && result.xml.Content) ? result.xml.Content : "";

              // éªŒè¯å…³é”®è¯
              const passed = expectedKeywords.some(k => reply.includes(k));
              
              if (passed) {
                console.log(`âœ… [é€šè¿‡]`);
                return true;
              } else {
                console.error(`âŒ [å¤±è´¥] å›å¤ä¸åŒ¹é…`);
                console.log("å›å¤æ‘˜è¦:", reply.replace(/\n/g, " ").substring(0, 100));
                return false;
              }
            } catch (err) {
              console.error(`ğŸš‘ [é”™è¯¯] ${err.message}`);
              return false;
            }
          }

          (async () => {
            console.log("ğŸ¥ ä½“æ£€å¼€å§‹...");
            if (!API_URL) {
              console.error("âŒ æœªé…ç½® API_URL");
              process.exit(1);
            }

            const failedItems = [];

            // 1. æµ‹æŸ¥ä»·
            if (!await testFeature("ä»·æ ¼æŸ¥è¯¢", "ä»·æ ¼ å¾®ä¿¡", ["ä»·æ ¼", "å…è´¹", "å†…è´­"])) {
              failedItems.push("æŸ¥ä»·æœåŠ¡");
            }

            // 2. æµ‹æ¦œå•
            if (!await testFeature("æ¦œå•è·å–", "æ¦œå• ç¾å›½", ["1ã€", "1.", "Top 10"])) {
              failedItems.push("æ¦œå•æœåŠ¡");
            }

            // 3. æµ‹ç³»ç»Ÿæ›´æ–°
            if (!await testFeature("ç³»ç»Ÿæ›´æ–°", "ç³»ç»Ÿæ›´æ–°", ["iOS", "ç‰ˆæœ¬", "iPadOS"])) {
              failedItems.push("æ›´æ–°æœåŠ¡");
            }

            if (failedItems.length > 0) {
              const summary = failedItems.join(" + ") + " å¼‚å¸¸";
              console.error(`\nâŒ ä½“æ£€ä¸é€šè¿‡: ${summary}`);
              const encodedError = encodeURIComponent(summary);
              try {
                fs.appendFileSync(process.env.GITHUB_OUTPUT, `fail_summary=${encodedError}\n`);
              } catch (e) {}
              process.exit(1);
            } else {
              console.log(`\nğŸ‰ æ‰€æœ‰åŠŸèƒ½æ­£å¸¸`);
              process.exit(0);
            }
          })();
          EOF

      # ğŸš€ æ‰§è¡Œä½“æ£€
      - name: Run Diagnosis
        id: diagnosis
        env:
          API_URL: 'https://apple.290935.xyz/api/wechat'
        run: node doctor.js

      # âŒ å¤±è´¥æŠ¥è­¦ (ç°æœ‰é€»è¾‘)
      - name: Bark Notification (Failure)
        if: failure()
        run: |
          ERROR_MSG="${{ steps.diagnosis.outputs.fail_summary }}"
          if [ -z "$ERROR_MSG" ]; then ERROR_MSG="æœªçŸ¥é”™è¯¯"; fi
          curl "https://api.day.app/${{ secrets.BARK_KEY }}/âŒä½“æ£€æŒ‚äº†/${ERROR_MSG}?group=BotDoctor&icon=https://github.githubassets.com/favicons/favicon-failure.svg&level=critical"

      # âœ…ã€æ–°å¢æ­¥éª¤ã€‘æ¢å¤é€šçŸ¥
      # è§¦å‘æ¡ä»¶ï¼šæœ¬æ¬¡è¿è¡ŒæˆåŠŸ (success) ä¸” ä¸Šæ¬¡è¿è¡Œæ˜¯å¤±è´¥ (was_failure == true)
      - name: Bark Notification (Recovery)
        if: success() && steps.last_run.outputs.was_failure == 'true'
        run: |
          curl "https://api.day.app/${{ secrets.BARK_KEY }}/âœ…æœåŠ¡å·²æ¢å¤/ä½“æ£€å„é¡¹æŒ‡æ ‡æ¢å¤æ­£å¸¸ï¼Œè‹¹æœæœåŠ¡å™¨åº”è¯¥ä¸æŠ½é£äº†ã€‚?group=BotDoctor&icon=https://github.githubassets.com/favicons/favicon-success.svg&level=active"
