name: Bot Doctor (å…¨é“¾è·¯ä½“æ£€ Pro)

on:
  schedule:
    - cron: '30 * * * *' # æ¯å°æ—¶çš„ç¬¬30åˆ†é’Ÿè¿è¡Œ
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  full_body_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: npm install axios xml2js

      - name: Run Diagnosis
        id: diagnosis
        env:
          # âš ï¸ ç¡®ä¿è¿™æ˜¯ä½ çš„ Vercel é¡¹ç›®çœŸå®åœ°å€ (å¸¦ /api/wechat)
          API_URL: 'https://apple.290935.xyz/api/wechat'
        run: |
          node -e '
            const axios = require("axios");
            const xml2js = require("xml2js");

            const API_URL = process.env.API_URL;
            const TIMEOUT = 20000; // 20ç§’è¶…æ—¶

            // ğŸ› ï¸ è¾…åŠ©å‡½æ•°
            async function testFeature(featureName, command, expectedKeywords) {
              console.log(`\n----------------------------------------`);
              console.log(`ğŸ©º [æ£€æµ‹é¡¹ç›®]: ${featureName}`);
              
              const payload = `
                <xml>
                  <ToUserName><![CDATA[gh_monitor]]></ToUserName>
                  <FromUserName><![CDATA[doctor_bot]]></FromUserName>
                  <CreateTime>${Math.floor(Date.now() / 1000)}</CreateTime>
                  <MsgType><![CDATA[text]]></MsgType>
                  <Content><![CDATA[${command}]]></Content>
                </xml>
              `;

              try {
                const res = await axios.post(API_URL, payload, {
                  headers: { "Content-Type": "text/xml" },
                  timeout: TIMEOUT
                });

                if (res.status !== 200) throw new Error(`HTTP ${res.status}`);

                const parser = new xml2js.Parser({ explicitArray: false });
                const result = await parser.parseStringPromise(res.data);
                const reply = (result && result.xml && result.xml.Content) ? result.xml.Content : "";

                // éªŒè¯å…³é”®è¯
                const passed = expectedKeywords.some(k => reply.includes(k));
                
                if (passed) {
                  console.log(`âœ… [é€šè¿‡] ${featureName} æ­£å¸¸`);
                  return true;
                } else {
                  console.error(`âŒ [å¤±è´¥] ${featureName} å›å¤å¼‚å¸¸`);
                  console.error(`å®Œæ•´å›å¤:\n${reply}`);
                  return false;
                }
              } catch (err) {
                console.error(`ğŸš‘ [è‡´å‘½é”™è¯¯] è¯·æ±‚å¤±è´¥: ${err.message}`);
                return false;
              }
            }

            // ğŸš€ ä¸»æ‰§è¡Œæµç¨‹
            (async () => {
              console.log("ğŸ¥ é™é»˜ä½“æ£€å¼€å§‹...");

              // 1. æµ‹è¯•æŸ¥ä»·
              if (!await testFeature("ä»·æ ¼æŸ¥è¯¢", "ä»·æ ¼ å¾®ä¿¡", ["ä»·æ ¼", "å…è´¹", "å†…è´­"])) process.exit(1);

              // 2. æµ‹è¯•æ¦œå•
              if (!await testFeature("æ¦œå•è·å–", "æ¦œå• ç¾å›½", ["1ã€", "1.", "Top 10"])) process.exit(1);

              // 3. æµ‹è¯•ç³»ç»Ÿæ›´æ–°
              if (!await testFeature("ç³»ç»Ÿæ›´æ–°", "ç³»ç»Ÿæ›´æ–°", ["iOS", "ç‰ˆæœ¬"])) process.exit(1);

              console.log(`\nğŸ‰ğŸ‰ğŸ‰ æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ (ä¸å‘é€é€šçŸ¥)`);
              process.exit(0);
            })();
          '

      # âŒ åªæœ‰å¤±è´¥æ—¶æ‰æŠ¥è­¦ (Success çš„æ­¥éª¤å·²è¢«åˆ é™¤)
      - name: Bark Notification (Failure)
        if: failure()
        run: |
          curl "https://api.day.app/${{ secrets.BARK_KEY }}/âŒä½“æ£€æŒ‚äº†/BotåŠŸèƒ½å¼‚å¸¸ï¼Œè¯·ç«‹å³æ£€æŸ¥!&level=critical?group=BotDoctor&icon=https://github.githubassets.com/favicons/favicon-failure.svg"
