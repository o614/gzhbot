name: Bot Doctor (å…¨é“¾è·¯ä½“æ£€)

on:
  schedule:
    - cron: '15 * * * *' # æ¯å°æ—¶çš„ç¬¬15åˆ†é’Ÿè‡ªåŠ¨è¿è¡Œä¸€æ¬¡
  workflow_dispatch: # å…è®¸ä½ æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®ç«‹åˆ»æ£€æµ‹

jobs:
  health_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Dependencies
        run: npm install axios xml2js

      - name: Run Diagnosis
        env:
          # âš ï¸ è¿™é‡Œå¡«ä½  Cloudflare æˆ–è€… Vercel çš„æœ€ç»ˆåœ°å€
          API_URL: 'https://apple.290935.xyz/api/wechat' 
        run: |
          node -e '
            const axios = require("axios");
            const xml2js = require("xml2js");

            // 1. æ„é€ æ¨¡æ‹Ÿå¾®ä¿¡çš„ XML è¯·æ±‚åŒ… (æ¨¡æ‹Ÿç”¨æˆ·å‘é€ "ä»·æ ¼ QQ")
            const mockPayload = `
              <xml>
                <ToUserName><![CDATA[gh_monitor]]></ToUserName>
                <FromUserName><![CDATA[monitor_tester]]></FromUserName>
                <CreateTime>${Math.floor(Date.now() / 1000)}</CreateTime>
                <MsgType><![CDATA[text]]></MsgType>
                <Content><![CDATA[ä»·æ ¼ QQ]]></Content>
              </xml>
            `;

            console.log("ğŸ¥ [åŒ»ç”Ÿ] å¼€å§‹å¯¹æœºå™¨äººè¿›è¡Œå…¨é¢ä½“æ£€...");
            console.log("ğŸ”— ç›®æ ‡æ¥å£:", process.env.API_URL);

            // 2. å‘é€ POST è¯·æ±‚ (æ¨¡æ‹Ÿå¾®ä¿¡æœåŠ¡å™¨)
            axios.post(process.env.API_URL, mockPayload, {
              headers: { "Content-Type": "text/xml" },
              timeout: 15000 // ç»™15ç§’è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢å†·å¯åŠ¨æ…¢
            })
            .then(async res => {
              console.log("âœ… HTTP çŠ¶æ€ç :", res.status);
              
              // 3. è§£æè¿”å›çš„ XML
              const parser = new xml2js.Parser({ explicitArray: false });
              const result = await parser.parseStringPromise(res.data);
              const replyText = result.xml.Content;

              console.log("ğŸ“ æœºå™¨äººå›å¤å†…å®¹æ‘˜è¦:", replyText.substring(0, 100) + "...");

              // 4. æ ¸å¿ƒé€»è¾‘åˆ¤æ–­ï¼šä¸ä»…è¦é€šï¼Œè¿˜è¦å¯¹ï¼
              // å¿…é¡»åŒ…å« "å†…è´­" æˆ–è€… "ä»·æ ¼" æ‰ç®—æˆåŠŸï¼Œå¦åˆ™è¯´æ˜çˆ¬è™«æŒ‚äº†
              if (replyText.includes("å†…è´­") || replyText.includes("ä»·æ ¼")) {
                console.log("ğŸ‰ [è¯Šæ–­ç»“æœ]ï¼šæœºå™¨äººéå¸¸å¥åº·ï¼å†…è´­æŠ“å–åŠŸèƒ½æ­£å¸¸ã€‚");
                process.exit(0); // æˆåŠŸé€€å‡º
              } else {
                console.error("ğŸ’‰ [è¯Šæ–­ç»“æœ]ï¼šæœºå™¨äººè¿˜æ´»ç€ï¼Œä½†â€œè„‘å­â€åäº†ï¼(æœªæ£€æµ‹åˆ°å†…è´­æ•°æ®)");
                console.error("å¯èƒ½æ˜¯ Apple å°äº† IPï¼Œæˆ–è€… Cheerio è§£æå¤±æ•ˆã€‚");
                process.exit(1); // æŠ¥é”™é€€å‡ºï¼Œè§¦å‘æŠ¥è­¦
              }
            })
            .catch(err => {
              console.error("ğŸš‘ [æŠ¢æ•‘å¤±è´¥]ï¼šè¿æ¥è¶…æ—¶æˆ–æœåŠ¡å™¨å´©æºƒï¼");
              console.error("é”™è¯¯è¯¦æƒ…:", err.message);
              if (err.response) {
                console.error("å“åº”æ•°æ®:", err.response.data);
              }
              process.exit(1); // æŠ¥é”™é€€å‡ºï¼Œè§¦å‘æŠ¥è­¦
            });
          '
